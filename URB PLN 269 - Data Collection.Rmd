---
title: "URB PLN 269"
author: "Aaron Barrall"
date: "01/18/2023"
output: html_document
---
# Load Packages, Setup
```{r}
library(tidyverse)
library(tidycensus)
library(spatial)
library(sf)
library(readxl)
#library(rsegregation)
library(leaflet)
library(tm)
library(mapview)
library(leafsync)
library(crsuggest)
library(rgeos)
set.seed(1234)
```
# Run this if you want to clear the data. 
```{r}
rm(list=ls())
```
# Census Data Pull - 5 Year ACS City, 2021
```{r}
#census_api_key("0bb4ac54f5ef401013b255be5f5c4f4d8960d00a", install=T)  #Census API key created for UCLA.

census_data <- load_variables (2021, "acs5", cache=T) #Load available data - use this to identify the table codes for the API call below.

vars <- c (median_income="B25119_001", #median income
           housing_units="B25003_001", #Housing Units total
           renter_occupied="B25003_003", #Tenure
           population_race="B03002_001", #race/ethnic total
           race_white="B03002_003", #white NH alone
           race_black="B03002_004", #black/african american NH
           race_amindian="B03002_005", #american indian/alaska native NH
           race_asian="B03002_006", #asian NH
           race_pacisl="B03002_007", #native hawaiian and other pacific islander NH
           race_other="B03002_008", #some other race alone NH
           race_twoplus="B03002_009", #two or more races NH
           race_hisp ="B03002_012", #total Hisp any race
           median_age ="B01002_001",
           median_gross_rent = "B25111_001", #median gross rent
           total_value_estimate = "B25075_001", #Total Household value?
           estimate_median_value = "B25077_001", #Median Household Value
           uis_tot = "B25024_001", #units in structure - total
           uis_1d = "B25024_002", #units in structure - 1 detached
           uis_1a = "B25024_003", #units in structure -1 attached
           uis_2 = "B25024_004", #units in structure - 2
           uis_3.4 = "B25024_005", #units in structure - 3 to 4
           uis_5.9 = "B25024_006", #units in structure - 5 to 9
           uis_10.19 = "B25024_007", #units in structure - 10 to 19
           uis_20.49 = "B25024_008", #units in structure - 20 to 49
           uis_50 = "B25024_009", #units in structure - 50+
           uis_mobile = "B25024_010", #units in structure - mobile home
           uis_van = "B25024_011", #units in structure -  Boat, RV and Van
           total_age = "B01001_001",
           male_u5 = "B01001_003", #male under 5 years
           male5.9 = "B01001_004", #males aged 5-10
           male65.66 = "B01001_020", #males 65-66
           male67.69 = "B01001_021",#male 67 to 69 years
           male70.74 = "B01001_022",#male 70 to 74 years
           male75.79 = "B01001_023",#male 75 to 79 years
           male80.84 = "B01001_024",#male 80 to 84 years
           male85andup = "B01001_025",#male 85+
           total_female = "B01001_026", #total female (sex by age)
           female_u5 = "B01001_027", #female 0 to 4 years
           female5.9 = "B01001_028", #female 5 to 9 years
           female65.66 = "B01001_044", #female 65 to 66 years
           female67.69 = "B01001_045", #female 67 to 69 years
           female70.74 = "B01001_046", #female 70 to 74 years
           female75.79 = "B01001_047", #female 75 to 79
           female80.84 = "B01001_048", #female 80 to 84
           female85andup = "B01001_049" #female 85 and above
           )
options(tigris_use_cache=TRUE)

acs_data_tract <-get_acs (state = "06", #California
                 geography = "tract",
                 variables = vars,
                 geometry = T,
                 survey = "acs5",
                 output = "wide",
                 year=2021)
# # 
# 
acs_data_tract <- acs_data_tract[, -grep("M$", colnames(acs_data_tract))]

# acs_data_city <-get_acs (state = "06", #California
#                  geography = "place",
#                  variables = vars,
#                  geometry = T,
#                  survey = "acs5",
#                  output = "wide",
#                  year=2021)

# acs_data_city <- acs_data_city[, -grep("M$", colnames(acs_data_city))] #Drop MOE Estimates

# write_csv(acs_data_city,"Output/census_direct_output_test.csv")

```
# Clean ACS Data
```{r}
# Convert UIS and Race data to Percents
# Units in Structure / tenure
acs_data_tract <- acs_data_tract %>% 
  mutate(uis_1d_per = uis_1dE/uis_totE) %>% 
  mutate(uis_1a_per = uis_1aE/uis_totE) %>% 
  mutate(uis_2_per = uis_2E/uis_totE) %>%
  mutate(uis_3.4_per = uis_3.4E/uis_totE) %>% 
  mutate(uis_5.9_per = uis_5.9E/uis_totE) %>% 
  mutate(uis_10.19_per = uis_10.19E/uis_totE) %>% 
  mutate(uis_20.49_per = uis_20.49E/uis_totE) %>% 
  mutate(renter_per = renter_occupiedE/housing_unitsE) %>% 
  mutate(race_white_per = race_whiteE/population_raceE) %>% 
  mutate(race_black_per = race_blackE/population_raceE) %>% 
  mutate(race_amindian_per = race_amindianE/population_raceE) %>% 
  mutate(race_asian_per = race_asianE/population_raceE) %>% 
  mutate(race_pacisl_per = race_pacislE/population_raceE) %>% 
  mutate(race_other_per = race_otherE/population_raceE) %>% 
  mutate(race_twoplus_per = race_twoplusE/population_raceE) %>% 
  mutate(race_hisp_per = race_hispE/population_raceE) %>%
  mutate(age_over_65_per = (male65.66E+male67.69E+male70.74E+male75.79E+male80.84E+male85andupE+                               female65.66E+female67.69E+female70.74E+female75.79E+female80.84E+
                              female85andupE)/total_ageE) %>% 
  #mutate_at(vars(uis_1d_per:age_over_65_per),funs(. * 100)) %>%  #multiply values by 100
  mutate_at(vars(uis_1d_per:age_over_65_per),funs(round(.,3))) %>%  # Round scaled values
  mutate(totalpop=population_raceE)

  acs_data_tract <- acs_data_tract %>% 
    rename(
      median_income = median_incomeE,
      median_age = median_ageE,
      median_gross_rent = median_gross_rentE,
      estimate_median_value = estimate_median_valueE,
      name = NAME)

acs_data_tract <- acs_data_tract[, -grep("E$", colnames(acs_data_tract))] #Drop remaining estimates, leaving only percent and necessary estimates


saveRDS(acs_data_tract,"Working/acs_data_tract.RDS")
#write_csv(acs_data_tract,"Working/CleanedTract.csv")

```
# Load in HCD Income Limits.

```{r}
#acs_data_tract_nospatial <- read_csv("Working/CleanedTract.csv")

acs_data_tract <- readRDS("Working/acs_data_tract.RDS")

#Identify the Counties in the data
acs_data_tract <- acs_data_tract %>% separate(col=name,into = c("tract","county","state"),sep=",") #Split the name column into three so we can see the Counties
  acs_data_tract$county <- str_remove(acs_data_tract$county," County")
  acs_data_tract$county <- trimws(acs_data_tract$county,"both")

HCD_Data <- read_csv("Input/2022-income-limits.csv")
  HCD_Data <- HCD_Data %>% select(County,AMI,LI_4) #LI 4 is county low income limit for family of four. 
  HCD_Data$County <- toupper(HCD_Data$County)
  acs_data_tract$county <- toupper(acs_data_tract$county)
  

combined <- acs_data_tract %>% left_join(HCD_Data,by=c("county"="County"))
combined$StateAMI80 <- 101600*0.8 #State AMI is $101,600
unique(combined[is.na(combined$AMI),"county"])  #Which counties are not working???!!!!  

```
# Is the tract below the income limit?
```{r}

combined$LowIncomeTract #Initialize the column.
combined$LowIncomeTract <- combined$median_income < combined$LI_4 | combined$median_income < combined$StateAMI80 #Add indicator column - True if income is below either state or County low income limit.

combined$LowIncomeState
combined$LowIncomeState <- combined$median_income < combined$StateAMI80

```

```{r}
# Testing out mapview
mapview(combined,zcol="LowIncomeTract") #Tracts that meet either one of the definitions of Low Income

mapview(combined,zcol="LowIncomeState") #Tracts that are below the state AMI.
```

# Load in CES/DAC Data
```{r}
CES4Final <- st_read("Input/CES4.gdb",layer="CES4_final")
DAC <- st_read("Input/SB535.gdb",layer="SB535tracts2022")
```
# Find Areas that are not SB 535, then see if they are low-income according to the state!
```{r}
DACM <- mapview(DAC)
IncomeM <- mapview(combined,zcol="LowIncomeTract")
sync(DACM,IncomeM)

#These maps show that there is a gap between DACs and what is considered a low-income area. 
```
# Data Crosswalk
```{r}
# Load the ACS crosswalk data, and do some basic conversions toso we can manipulate them later.
crosswalk <- read.table("Input/tab20_tract20_tract10_st06.txt",sep="|")
colnames(crosswalk) <- crosswalk[1,]
crosswalk <- crosswalk[-1,]
crosswalk <- crosswalk %>% select(GEOID_TRACT_20,GEOID_TRACT_10,AREALAND_TRACT_20,AREALAND_TRACT_10,AREALAND_PART,AREAWATER_PART) %>% 
  mutate(Tract10Num=as.numeric(GEOID_TRACT_10),
         AREALAND_TRACT_20=as.numeric(AREALAND_TRACT_20),
         AREALAND_TRACT_10=as.numeric(AREALAND_TRACT_10),
         AREALAND_PART=as.numeric(AREALAND_PART),
         PercentPrevious=AREALAND_PART*100/AREALAND_TRACT_20
         )

# Join Crosswalk to ACS_Data
  combined <- right_join(combined,crosswalk,by=c("GEOID"="GEOID_TRACT_20")) # Use a right join to retain the geometry

#Get rid of geometry so we can use a DPLYR join (can't join two geometries to each other)
  CES4_nogeom <- st_drop_geometry(CES4Final)
  DAC_nogeom <- st_drop_geometry(DAC)

DAC_nogeom <- DAC_nogeom %>% select(Tract,DAC_category) #Select the important columns in the DAC field.

#Join the CES and DAC information.
combined <- left_join(combined,CES4_nogeom,by=c("Tract10Num"="Tract"))
combined <- left_join(combined,DAC_nogeom,by=c("Tract10Num"="Tract"))

combined <- combined %>% mutate(
  PollutionAWeighted = (PercentPrevious*PollutionScore)/100   #This will be used below to calculate the areal weighted average for the pollution scores by tract. 
)

# Taking the Average of CES Scores for the new geometries
data <- combined %>% group_by(GEOID) %>% 
  mutate_each(funs(mean),PollutionAWeighted,PollutionScore) %>%  
  distinct(GEOID,.keep_all=TRUE) #PollutionAWeighted is the area weighted score, while the pollution score is just the unadjusted average.

#Identify Possibe DACs (that are not considered DACs by CES)!
data$possibleDAC <- NA
data$possibleDAC <- data$LowIncomeTract==TRUE & is.na(data$DAC_category)==TRUE

sum(data$possibleDAC==T,na.rm=T)  # There are potentially 3411 DACs based on the income provisions of SB 1000. 
```
# Local Ranking of CalEnviroScreen, Identification of new DACs based on income and CES local pollution scores.

```{r}
#Rank the Area Weighted Pollution scores within each County, calculate a percentile rank.
data<- data %>% group_by(County) %>% mutate(Pollution_County = rank(PollutionAWeighted),
                                            CountyPercentile = Pollution_County/length(Pollution_County))

#
data$HighLocalPollution <- NA
data$HighLocalPollution <- data$CountyPercentile >=.75

data$LOCALDAC <- data$HighLocalPollution==TRUE & data$possibleDAC==TRUE
sum(data$LOCALDAC,na.rm=T)  #THIS METHOD IDENTIFIES 699 NEW CENSUS TRACTS THAT WERE PREVIOUSLY NOT CONSIDERED!!!!!!!!

#mapview(data,zcol="LOCALDAC")+mapview(DAC)
```

# Spatial Join the data sources
## Reproject the Data
```{r}
st_crs(CES4Final) #EPSG 3310
st_crs(combined) #EPSG 4269

CES4Final <- st_transform(CES4Final,4269) #Transform the CES to the same reference system as the ACS data. 
```
## Conduct a Spatial Join
```{r}
combined_Centroid <- st_point_on_surface(combined)

sf::sf_use_s2(FALSE)

spJoined <- st_join(
    combined_Centroid,CES4Final,
    join=st_intersects,
    suffix=c("_acs","_CES"),
    sparse=TRUE,
    left=TRUE
  )



mapview(combined)+
  mapview(combined_Centroid)

```

# Working - Not used code
```{r}
# Testing out Leaflet
pal <- colorNumeric(
  palette = "red",
  domain=combined$LowIncomeTract
)

combined %>% 
  st_transform(crs="+init=epsg:4326") %>% 
  leaflet() %>% 
  addTiles() %>% 
  addPolygons(data=combined,
              fillColor = ~pal(LowIncomeTract))




```
# Calculate Divergence
```{r}

california_divergence <- acs_data_tract %>% 
  summarise(ca_divergence = divergence(race_white_per,race_black_per,race_amindian_per,race_asian_per,race_pacisl_per,race_other_per,race_twoplus_per,race_hisp_per,population = totalpop, summed=T))

write_csv(california_divergence,"Output/DivergenceCA.csv")

```

